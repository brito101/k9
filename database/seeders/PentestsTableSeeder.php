<?php

namespace Database\Seeders;

use App\Models\Pentest;
use App\Models\Vulnerability;
use Carbon\Carbon;
use Illuminate\Database\Seeder;

class PentestsTableSeeder extends Seeder
{
    /**
     * Run the database seeds.
     *
     * Seeder para criar pentests de teste com vulnerabilidades associadas.
     * Gera 50 pentests com dados aleatórios para testes.
     *
     * @return void
     */
    public function run()
    {
        if (env('APP_ENV') === 'local') {
            // Dados para geração aleatória
            $applications = [
                'Portal Corporativo', 'Sistema ERP', 'API REST', 'Mobile App',
                'E-commerce', 'CRM', 'Sistema Financeiro', 'Portal Cliente',
                'Intranet', 'Sistema RH', 'Dashboard Analytics', 'Plataforma Digital',
                'Sistema Logística', 'Portal Fornecedores', 'App Mobile Banking',
            ];

            $applicants = ['João Silva', 'Maria Santos', 'Carlos Oliveira', 'Ana Costa', 'Pedro Almeida'];
            $responsibles = ['Equipe Segurança', 'DevSecOps Team', 'Security Team', 'Infra Security', 'AppSec Team'];
            $priorities = ['low', 'medium', 'high', 'urgent'];
            $criticalities = ['informative', 'low', 'medium', 'high', 'critical'];

            $vulnerabilityDescriptions = [
                'SQL Injection na busca de usuários',
                'Cross-Site Scripting (XSS) no formulário de comentários',
                'Exposição de informações sensíveis no log',
                'Autenticação fraca com senhas padrão',
                'CSRF na funcionalidade de transferência',
                'Falta de validação de entrada em upload de arquivos',
                'Sessão não expira após logout',
                'Credenciais hardcoded no código-fonte',
                'Falta de rate limiting na API',
                'Cabeçalhos de segurança ausentes',
                'Configuração inadequada de CORS',
                'Uso de bibliotecas desatualizadas',
                'Falta de criptografia em dados sensíveis',
                'Path Traversal em download de arquivos',
                'Injection em comando do sistema operacional',
                'Deserialização insegura',
                'Exposição de endpoints administrativos',
                'Broken Access Control',
                'Security Misconfiguration',
                'Sensitive Data Exposure',
            ];

            $notes = [
                'Teste realizado conforme escopo aprovado.',
                'Identificadas vulnerabilidades críticas que necessitam atenção imediata.',
                'Sistema apresenta boas práticas de segurança em geral.',
                'Recomendada revisão completa da arquitetura de autenticação.',
                'Necessário atualizar dependências vulneráveis.',
                null,
            ];

            $conclusions = [
                '<p>Durante a execução dos testes de segurança, foram identificadas diversas vulnerabilidades que impactam diretamente a segurança da aplicação. A análise técnica revelou falhas críticas que podem comprometer a confidencialidade, integridade e disponibilidade dos dados.</p><p>As vulnerabilidades encontradas incluem problemas relacionados a falhas de autenticação e autorização, exposição de informações sensíveis, validação inadequada de entrada de dados, e configurações inseguras de servidor. Essas falhas podem ser exploradas por atacantes mal-intencionados para obter acesso não autorizado ao sistema.</p><p>Recomenda-se que a equipe de desenvolvimento priorize a correção das vulnerabilidades críticas e altas imediatamente, seguindo as orientações detalhadas fornecidas no relatório. As vulnerabilidades médias e baixas devem ser tratadas em um segundo momento, mas não devem ser negligenciadas.</p><p>É importante estabelecer um programa contínuo de segurança da informação que inclua revisões periódicas de código, testes de penetração regulares, treinamento de desenvolvedores em práticas seguras de programação e implementação de um processo de gestão de vulnerabilidades.</p><p>A aplicação de patches de segurança, atualização de bibliotecas e frameworks para versões mais recentes, implementação de controles de segurança em camadas e monitoramento contínuo são medidas essenciais para manter o nível adequado de segurança.</p><p>Conclui-se que o sistema necessita de atenção imediata nas áreas identificadas e que o comprometimento da equipe técnica é fundamental para garantir a segurança dos dados e a continuidade dos negócios da organização.</p>',
                '<p>O teste de penetração realizado demonstrou que a aplicação possui uma arquitetura de segurança robusta em sua concepção, porém foram identificados pontos de atenção que merecem ser endereçados pela equipe técnica responsável.</p><p>A infraestrutura apresenta configurações adequadas em relação aos protocolos de comunicação, implementação de TLS e gestão de certificados digitais. Os mecanismos de autenticação e autorização demonstraram conformidade com as melhores práticas do mercado.</p><p>Contudo, observou-se que algumas bibliotecas de terceiros utilizadas no projeto encontram-se desatualizadas e apresentam vulnerabilidades conhecidas documentadas em bases públicas como CVE e NVD. Recomenda-se atualização imediata destes componentes.</p><p>O tratamento de erros e exceções necessita de revisão para evitar a exposição de informações técnicas que possam auxiliar potenciais atacantes no mapeamento da infraestrutura e identificação de vetores de ataque adicionais.</p><p>Os logs de aplicação e auditoria estão adequadamente implementados, facilitando investigações forenses e detecção de anomalias. Sugere-se a integração com uma solução SIEM para correlação de eventos em tempo real.</p><p>De modo geral, a aplicação demonstra maturidade em segurança, necessitando apenas de ajustes pontuais e manutenção preventiva contínua para manter seu nível de proteção adequado.</p>',
                '<p>A análise de segurança conduzida identificou vulnerabilidades graves que comprometem a postura de segurança da aplicação. Os testes revelaram falhas estruturais que permitem exploração por atacantes com conhecimento técnico básico.</p><p>Foram identificadas vulnerabilidades de injeção de código em múltiplos pontos da aplicação, incluindo SQL Injection, Command Injection e LDAP Injection. Essas falhas decorrem da ausência de sanitização e validação adequada dos dados fornecidos pelos usuários.</p><p>O mecanismo de controle de acesso apresenta falhas de implementação que permitem escalação de privilégios e acesso não autorizado a funcionalidades administrativas. Usuários comuns conseguem acessar recursos restritos através de manipulação de parâmetros.</p><p>A gestão de sessões está inadequada, com tokens previsíveis, ausência de rotação de identificadores e falta de implementação de timeout apropriado. Isto permite sequestro de sessão e ataques de fixação.</p><p>Dados sensíveis são transmitidos sem criptografia adequada em determinados fluxos da aplicação, violando princípios de confidencialidade e regulamentações de proteção de dados como LGPD e GDPR.</p><p>É imperativo que a organização trate as vulnerabilidades críticas com máxima urgência, reestruturando componentes de segurança fundamentais antes que ocorram incidentes de segurança que possam resultar em perdas financeiras e danos reputacionais significativos.</p>',
                '<p>O assessment de segurança demonstrou que a aplicação foi desenvolvida seguindo princípios de Secure Development Lifecycle, evidenciando preocupação da equipe de desenvolvimento com aspectos de segurança desde as fases iniciais do projeto.</p><p>A implementação de defesas em profundidade está adequada, com múltiplas camadas de proteção incluindo WAF, IPS/IDS, validação client-side e server-side, sanitização de saída e encoding apropriado conforme contexto de uso dos dados.</p><p>Os cabeçalhos de segurança HTTP estão corretamente configurados, incluindo Content-Security-Policy, X-Frame-Options, Strict-Transport-Security e X-Content-Type-Options, proporcionando proteção contra diversos vetores de ataque comuns.</p><p>A arquitetura do sistema segue o princípio do menor privilégio, com segregação adequada de funções e separação de ambientes de desenvolvimento, homologação e produção com controles de acesso distintos.</p><p>Mecanismos de rate limiting e throttling estão implementados nas APIs públicas, prevenindo ataques de força bruta e negação de serviço. O monitoramento de comportamento anômalo está ativo e integrado ao processo de resposta a incidentes.</p><p>Conclui-se que a aplicação apresenta excelente maturidade em segurança, servindo como referência de boas práticas para demais projetos da organização. Recomenda-se manutenção do programa de segurança contínua e realização de testes periódicos.</p>',
                '<p>Os testes de invasão revelaram múltiplas vulnerabilidades de severidade variada que necessitam correção urgente. A superfície de ataque da aplicação é significativa devido à complexidade de suas funcionalidades e integrações com sistemas externos.</p><p>Vulnerabilidades de Cross-Site Scripting foram identificadas em diversos formulários e campos de entrada, permitindo injeção de código JavaScript malicioso que pode comprometer sessões de usuários legítimos e realizar ações não autorizadas.</p><p>A configuração do CORS está excessivamente permissiva, permitindo requisições de origens não confiáveis. Isto possibilita ataques Cross-Site Request Forgery e exfiltração de dados através de domínios controlados por atacantes.</p><p>O processo de upload de arquivos não realiza validação adequada de tipos MIME e extensões, permitindo upload de scripts server-side que podem ser executados no servidor, comprometendo totalmente a infraestrutura.</p><p>Credenciais padrão foram encontradas em alguns componentes administrativos que não tiveram suas senhas alteradas durante o processo de implantação, representando grave risco de acesso não autorizado por atacantes que utilizem listas de credenciais comuns.</p><p>Recomenda-se intervenção urgente nas vulnerabilidades críticas, seguida de revisão abrangente de todo código-fonte por equipe especializada em segurança de aplicações. Implementação de programa de secure coding e automação de testes de segurança no pipeline CI/CD são essenciais para prevenção de reincidências.</p>',
            ];

            $recommendations = [
                '<p>Para mitigar esta vulnerabilidade, é fundamental implementar uma abordagem em múltiplas camadas que inclua validação rigorosa de entrada de dados, sanitização adequada de saídas e implementação de controles de segurança apropriados.</p><p>Recomenda-se a utilização de frameworks e bibliotecas atualizadas que ofereçam proteções nativas contra este tipo de vulnerabilidade. É essencial aplicar o princípio do menor privilégio em todos os níveis da aplicação e implementar controles de acesso baseados em funções.</p><p>A equipe de desenvolvimento deve realizar uma revisão completa do código-fonte para identificar outras instâncias similares desta vulnerabilidade. Utilize ferramentas de análise estática de código (SAST) e análise dinâmica (DAST) para automatizar a detecção de falhas de segurança.</p><p>Implemente testes de segurança automatizados no pipeline de CI/CD para prevenir a introdução de novas vulnerabilidades. Estabeleça políticas de codificação segura e realize treinamentos regulares com a equipe técnica sobre as melhores práticas de desenvolvimento seguro.</p><p>Configure adequadamente os cabeçalhos de segurança HTTP, implemente Content Security Policy (CSP), ative proteções contra CSRF e garanta que todas as comunicações utilizem TLS 1.2 ou superior. Mantenha um inventário atualizado de todas as dependências e monitore continuamente por vulnerabilidades conhecidas.</p><p>Por fim, estabeleça um processo de resposta a incidentes e mantenha logs detalhados de todas as atividades críticas do sistema para facilitar investigações futuras e melhorar continuamente a postura de segurança da aplicação.</p>',
                '<p>Implemente validação de entrada em todas as camadas da aplicação, utilizando whitelist de caracteres permitidos ao invés de blacklist. Rejeite dados malformados ou suspeitos antes que sejam processados pela lógica de negócio.</p><p>Utilize prepared statements ou parameterized queries para todas as interações com banco de dados, evitando concatenação direta de strings SQL com dados fornecidos por usuários. Isso previne efetivamente ataques de SQL Injection.</p><p>Configure o servidor web para retornar páginas de erro genéricas que não exponham detalhes técnicos da implementação. Stack traces, versões de software e caminhos de arquivos não devem ser revelados em mensagens de erro.</p><p>Implemente autenticação multifator para acessos administrativos e contas privilegiadas. Utilize algoritmos robustos de hashing como bcrypt ou Argon2 para armazenamento de senhas, com salt único por usuário.</p><p>Estabeleça política de senha forte com requisitos mínimos de complexidade, tamanho e rotação periódica. Implemente detecção de tentativas de força bruta com bloqueio temporário de contas após múltiplas tentativas falhas consecutivas.</p><p>Revise e atualize regularmente todas as bibliotecas, frameworks e componentes de terceiros utilizados no projeto. Monitore repositórios de vulnerabilidades conhecidas e aplique patches de segurança assim que disponibilizados pelos fabricantes.</p>',
                '<p>Implemente encoding adequado de saída conforme o contexto de uso dos dados (HTML, JavaScript, URL, CSS). Utilize funções nativas do framework para escapar caracteres especiais e prevenir interpretação de código malicioso.</p><p>Configure Content Security Policy restritiva que permita apenas carregamento de recursos de origens confiáveis. Bloqueie execução de JavaScript inline e eventos handlers HTML para reduzir superfície de ataque XSS.</p><p>Implemente tokens anti-CSRF em todos os formulários que realizam operações sensíveis. Valide o token no servidor antes de processar requisições state-changing e rejeite requisições que não contenham token válido.</p><p>Configure CORS de forma restritiva, permitindo apenas origens específicas que realmente necessitam acessar os recursos. Evite uso de wildcard e valide headers de origem antes de retornar Access-Control-Allow-Origin.</p><p>Implemente validação robusta de tipos de arquivo em uploads, verificando não apenas extensão mas também magic numbers e conteúdo real do arquivo. Armazene arquivos fora do webroot e sirva através de script que force download ao invés de execução.</p><p>Estabeleça processo de revisão de código focado em segurança, com checklist de verificação de vulnerabilidades comuns. Capacite desenvolvedores em secure coding através de treinamentos periódicos e workshops práticos.</p>',
                '<p>Remova imediatamente todas as credenciais hardcoded do código-fonte e migre para sistema de gerenciamento de segredos como HashiCorp Vault, AWS Secrets Manager ou Azure Key Vault.</p><p>Implemente rotação automática de credenciais em intervalos regulares eforce alteração de senhas padrão durante processo de instalação ou primeiro acesso ao sistema.</p><p>Configure rate limiting em APIs e endpoints críticos para prevenir ataques de enumeração, força bruta e negação de serviço. Implemente backoff exponencial para tentativas de autenticação falhadas.</p><p>Implemente logging abrangente de eventos de segurança incluindo tentativas de acesso, modificações de dados sensíveis, alterações de configuração e execução de operações administrativas. Garanta integridade e imutabilidade dos logs.</p><p>Estabeleça monitoramento contínuo de logs com alertas em tempo real para comportamentos suspeitos como múltiplas tentativas de autenticação falhadas, acessos fora do horário comercial, ou operações anômalas.</p><p>Realize testes de penetração periódicos por equipe independente para validar efetividade dos controles de segurança implementados. Documente e acompanhe correção de todas as vulnerabilidades identificadas até sua completa remediação.</p>',
                '<p>Atualize imediatamente todas as bibliotecas e frameworks para suas versões mais recentes que incluam correções de segurança. Verifique changelogs e security advisories antes de atualizar para garantir compatibilidade.</p><p>Implemente política de gestão de dependências com scanning automatizado de vulnerabilidades conhecidas. Integre ferramentas como OWASP Dependency Check, Snyk ou WhiteSource no pipeline de build.</p><p>Configure segregação de rede adequada com firewalls entre camadas da aplicação. Implemente princípio de menor privilégio em regras de firewall, permitindo apenas tráfego explicitamente necessário.</p><p>Implemente criptografia de dados sensíveis em repouso utilizando algoritmos robustos como AES-256. Gerencie chaves criptográficas adequadamente com rotação periódica e armazenamento seguro separado dos dados.</p><p>Force uso de HTTPS em toda aplicação através de redirecionamento automático e HSTS. Configure TLS 1.2 ou superior como versão mínima, desabilitando protocolos e cipher suites inseguros.</p><p>Estabeleça programa de conscientização de segurança para todos os stakeholders envolvidos no desenvolvimento e manutenção da aplicação. Promova cultura de segurança como responsabilidade compartilhada de toda equipe.</p>',
            ];

            echo "Iniciando criação de 50 pentests...\n\n";

            for ($i = 1; $i <= 50; $i++) {
                // Define ano distribuído entre 2024, 2025 e 2026
                $rand = rand(1, 10);
                if ($rand <= 2) {
                    $year = 2024;
                } elseif ($rand <= 5) {
                    $year = 2025;
                } else {
                    $year = 2026;
                }

                // Busca o maior order_number do ano
                $maxOrder = Pentest::where('year', $year)->max('order_number') ?? 0;
                $orderNumber = $maxOrder + 1;
                $yearNumber = str_pad($orderNumber, 2, '0', STR_PAD_LEFT).'/'.$year;

                // Define datas base
                $startDate = null;
                $completionDate = null;
                $deliveryDate = null;
                $deadline = null;
                $requestDate = null;

                // 80% tem data de solicitação
                if (rand(1, 10) > 2) {
                    $requestDate = Carbon::create($year, rand(1, 12), rand(1, 28));
                }

                // 70% tem data de início
                if (rand(1, 10) > 3) {
                    $startDate = Carbon::create($year, rand(1, 12), rand(1, 28));

                    // 60% dos que iniciaram têm prazo
                    if (rand(1, 10) > 4) {
                        $deadline = (clone $startDate)->addDays(rand(15, 90));
                    }

                    // 50% dos que iniciaram foram finalizados
                    if (rand(1, 10) > 5) {
                        $completionDate = (clone $startDate)->addDays(rand(10, 80));

                        // 80% dos finalizados têm data de entrega
                        if (rand(1, 10) > 2) {
                            $deliveryDate = (clone $completionDate)->addDays(rand(1, 10));
                        }
                    }
                }

                $pentest = Pentest::create([
                    'application_name' => $applications[array_rand($applications)].' v'.rand(1, 5).'.'.rand(0, 9),
                    'year' => $year,
                    'order_number' => $orderNumber,
                    'year_number' => $yearNumber,
                    'version' => rand(1, 5).'.'.rand(0, 9).'.'.rand(0, 20),
                    'applicant' => $applicants[array_rand($applicants)],
                    'request_date' => $requestDate,
                    'priority' => $priorities[array_rand($priorities)],
                    'start_date' => $startDate,
                    'completion_date' => $completionDate,
                    'delivery_date' => $deliveryDate,
                    'deadline' => $deadline,
                    'responsible' => $responsibles[array_rand($responsibles)],
                    'notes' => $notes[array_rand($notes)],
                    'risk_assessment' => rand(1, 10) > 3 ? '<p>Análise de risco realizada. '.(rand(1, 10) > 5 ? 'Riscos elevados identificados.' : 'Riscos moderados a baixos.').'</p>' : null,
                    'conclusion' => rand(1, 10) > 3 ? $conclusions[array_rand($conclusions)] : null,
                ]);

                // Criar vulnerabilidades (entre 0 e 15)
                $numVulnerabilities = rand(0, 15);

                for ($j = 0; $j < $numVulnerabilities; $j++) {
                    $criticality = $criticalities[array_rand($criticalities)];
                    $isResolved = rand(1, 10) > 4; // 60% mitigadas
                    $resolvedAt = null;
                    $mitigationAction = null;

                    if ($isResolved && $completionDate) {
                        $resolvedAt = (clone $startDate)->addDays(rand(5, 70));
                    } elseif ($isResolved && $startDate) {
                        $resolvedAt = (clone $startDate)->addDays(rand(5, 30));
                    }

                    // Se foi mitigada, 70% têm ação de mitigação documentada
                    if ($isResolved && rand(1, 10) > 3) {
                        $actions = [
                            '<p>Aplicado patch de segurança fornecido pelo fabricante.</p>',
                            '<p>Implementada validação de entrada no lado do servidor.</p>',
                            '<p>Atualizada biblioteca vulnerável para versão mais recente.</p>',
                            '<p>Configurado header de segurança adequado no servidor.</p>',
                            '<p>Implementado controle de acesso baseado em roles.</p>',
                            '<p>Removidas credenciais hardcoded e migradas para variáveis de ambiente.</p>',
                            '<p>Implementado rate limiting na API.</p>',
                            '<p>Corrigida lógica de autenticação e fortalecida política de senhas.</p>',
                        ];
                        $mitigationAction = $actions[array_rand($actions)];
                    }

                    Vulnerability::create([
                        'pentest_id' => $pentest->id,
                        'description' => $vulnerabilityDescriptions[array_rand($vulnerabilityDescriptions)],
                        'criticality' => $criticality,
                        'is_resolved' => $isResolved,
                        'resolved_at' => $resolvedAt,
                        'mitigation_action' => $mitigationAction,
                        'recommendations' => rand(1, 10) > 5 ? $recommendations[array_rand($recommendations)] : null,
                    ]);
                }

                echo "Pentest $i criado: {$yearNumber} - {$pentest->application_name} ({$numVulnerabilities} vulnerabilidades)\n";
            }

            echo "\n✅ Concluído! 50 pentests criados com sucesso!\n";
        }
    }
}
