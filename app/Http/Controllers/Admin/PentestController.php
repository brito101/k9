<?php

namespace App\Http\Controllers\Admin;

use App\Helpers\CheckPermission;
use App\Http\Controllers\Controller;
use App\Http\Requests\Admin\PentestRequest;
use App\Models\Pentest;
use Illuminate\Contracts\Foundation\Application;
use Illuminate\Contracts\View\Factory;
use Illuminate\Contracts\View\View;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Str;
use Yajra\DataTables\Facades\DataTables;

class PentestController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index(Request $request): View|Factory|Application|JsonResponse
    {
        CheckPermission::checkAuth('Listar Pentests');

        if ($request->ajax()) {
            $pentests = Pentest::all([
                'id',
                'versao',
                'autor',
                'data_inicio',
                'data_finalizacao',
                'data_prazo_final',
                'responsavel',
            ]);

            $token = csrf_token();

            return DataTables::of($pentests)
                ->addIndexColumn()
                ->addColumn('action', function ($row) use ($token) {
                    return '<a class="btn btn-xs btn-info mx-1 shadow" title="Visualizar" href="pentests/'.$row->id.'"><i class="fa fa-lg fa-fw fa-eye"></i></a>'.
                        '<a class="btn btn-xs btn-primary mx-1 shadow" title="Editar" href="pentests/'.$row->id.'/edit"><i class="fa fa-lg fa-fw fa-pen"></i></a>'.
                        '<form method="POST" action="pentests/'.$row->id.'" class="btn btn-xs px-0"><input type="hidden" name="_method" value="DELETE"><input type="hidden" name="_token" value="'.$token.'"><button class="btn btn-xs btn-danger mx-1 shadow" title="Excluir" onclick="return confirm(\'Confirma a exclusão deste pentest?\')"><i class="fa fa-lg fa-fw fa-trash"></i></button></form>';
                })
                ->addColumn('status', function ($row) {
                    if ($row->data_finalizacao) {
                        return '<span class="badge badge-success">Finalizado</span>';
                    } elseif ($row->data_prazo_final < now()) {
                        return '<span class="badge badge-danger">Atrasado</span>';
                    } else {
                        return '<span class="badge badge-warning">Em Andamento</span>';
                    }
                })
                ->editColumn('data_inicio', function ($row) {
                    return $row->data_inicio ? $row->data_inicio->format('d/m/Y') : '-';
                })
                ->editColumn('data_finalizacao', function ($row) {
                    return $row->data_finalizacao ? $row->data_finalizacao->format('d/m/Y') : '-';
                })
                ->editColumn('data_prazo_final', function ($row) {
                    return $row->data_prazo_final ? $row->data_prazo_final->format('d/m/Y') : '-';
                })
                ->rawColumns(['action', 'status'])
                ->make(true);
        }

        return view('admin.pentests.index');
    }

    /**
     * Display the specified resource.
     */
    public function show(string $id): View|\Illuminate\Foundation\Application|Factory|Application
    {
        CheckPermission::checkAuth('Visualizar Pentests');

        $pentest = Pentest::find($id);
        if (! $pentest) {
            abort(403, 'Acesso não autorizado');
        }

        return view('admin.pentests.show', compact('pentest'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create(): View|\Illuminate\Foundation\Application|Factory|Application
    {
        CheckPermission::checkAuth('Criar Pentests');

        return view('admin.pentests.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(PentestRequest $request): RedirectResponse
    {
        CheckPermission::checkAuth('Criar Pentests');

        $data = $request->all();

        if ($request->hasFile('arquivo') && $request->file('arquivo')->isValid()) {
            $fileName = 'pentest_'.Str::slug($data['versao']).'_'.time().'.'.$request->file('arquivo')->getClientOriginalExtension();
            $request->file('arquivo')->storeAs('pentests', $fileName, 'public');
            $data['arquivo'] = $fileName;
        }

        $pentest = Pentest::create($data);

        if ($pentest->save()) {
            return redirect()
                ->route('admin.pentests.index')
                ->with('success', 'Cadastro realizado!');
        } else {
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Erro ao cadastrar!');
        }
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(string $id): View|\Illuminate\Foundation\Application|Factory|Application
    {
        CheckPermission::checkAuth('Editar Pentests');

        $pentest = Pentest::find($id);
        if (! $pentest) {
            abort(403, 'Acesso não autorizado');
        }

        return view('admin.pentests.edit', compact('pentest'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(PentestRequest $request, string $id): RedirectResponse
    {
        CheckPermission::checkAuth('Editar Pentests');

        $pentest = Pentest::find($id);
        if (! $pentest) {
            abort(403, 'Acesso não autorizado');
        }

        $data = $request->all();

        if ($request->hasFile('arquivo') && $request->file('arquivo')->isValid()) {
            // Remove arquivo antigo se existir
            if ($pentest->arquivo && File::exists(storage_path('app/public/pentests/'.$pentest->arquivo))) {
                File::delete(storage_path('app/public/pentests/'.$pentest->arquivo));
            }

            $fileName = 'pentest_'.Str::slug($data['versao']).'_'.time().'.'.$request->file('arquivo')->getClientOriginalExtension();
            $request->file('arquivo')->storeAs('pentests', $fileName, 'public');
            $data['arquivo'] = $fileName;
        }

        if ($pentest->update($data)) {
            return redirect()
                ->route('admin.pentests.index')
                ->with('success', 'Atualização realizada!');
        } else {
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Erro ao atualizar!');
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(string $id): RedirectResponse
    {
        CheckPermission::checkAuth('Excluir Pentests');

        $pentest = Pentest::find($id);
        if (! $pentest) {
            abort(403, 'Acesso não autorizado');
        }

        // Não remove o arquivo fisicamente para manter histórico
        if ($pentest->delete()) {
            return redirect()
                ->route('admin.pentests.index')
                ->with('success', 'Exclusão realizada!');
        } else {
            return redirect()
                ->back()
                ->with('error', 'Erro ao excluir!');
        }
    }
}
