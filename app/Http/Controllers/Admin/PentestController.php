<?php

namespace App\Http\Controllers\Admin;

use App\Helpers\CheckPermission;
use App\Helpers\TextProcessor;
use App\Http\Controllers\Controller;
use App\Http\Requests\Admin\PentestRequest;
use App\Models\Pentest;
use Illuminate\Contracts\Foundation\Application;
use Illuminate\Contracts\View\Factory;
use Illuminate\Contracts\View\View;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\File;
use Illuminate\Support\Str;
use Yajra\DataTables\Facades\DataTables;

class PentestController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index(Request $request): View|Factory|Application|JsonResponse
    {
        CheckPermission::checkAuth('Listar Pentests');

        if ($request->ajax()) {
            $pentests = Pentest::select([
                'id',
                'year_number',
                'year',
                'order_number',
                'application_name',
                'version',
                'responsible',
                'priority',
                'start_date',
                'completion_date',
                'deadline',
                'applicant',
                'request_date',
            ]);

            $token = csrf_token();
            $user = auth()->user();

            return DataTables::eloquent($pentests)
                ->addIndexColumn()
                ->addColumn('action', function ($row) use ($token, $user) {
                    $actions = '';

                    // Botão Visualizar - todos com permissão "Visualizar Pentests" podem ver
                    if ($user->can('Visualizar Pentests')) {
                        $actions .= '<a class="btn btn-xs btn-info mx-1 shadow" title="Visualizar" href="pentests/'.$row->id.'"><i class="fa fa-lg fa-fw fa-eye"></i></a>';
                    }

                    // Botão Editar - apenas quem tem permissão "Editar Pentests"
                    if ($user->can('Editar Pentests')) {
                        $actions .= '<a class="btn btn-xs btn-primary mx-1 shadow" title="Editar" href="pentests/'.$row->id.'/edit"><i class="fa fa-lg fa-fw fa-pen"></i></a>';
                    }

                    // Botão Criar Vulnerabilidade - apenas quem tem permissão "Criar Vulnerabilidades"
                    if ($user->can('Criar Vulnerabilidades')) {
                        $actions .= '<form method="POST" action="'.route('admin.vulnerabilities.create.post').'" class="d-inline"><input type="hidden" name="_token" value="'.$token.'"><input type="hidden" name="pentest_id" value="'.$row->id.'"><button class="btn btn-xs btn-warning mx-1 shadow" title="Cadastrar Vulnerabilidade"><i class="fa fa-lg fa-fw fa-bug"></i></button></form>';
                    }

                    // Botão Excluir - apenas quem tem permissão "Excluir Pentests"
                    if ($user->can('Excluir Pentests')) {
                        $actions .= '<form method="POST" action="pentests/'.$row->id.'" class="btn btn-xs px-0"><input type="hidden" name="_method" value="DELETE"><input type="hidden" name="_token" value="'.$token.'"><button class="btn btn-xs btn-danger mx-1 shadow" title="Excluir" onclick="return confirm(\'Confirma a exclusão deste pentest?\')"><i class="fa fa-lg fa-fw fa-trash"></i></button></form>';
                    }

                    return $actions;
                })
                ->filterColumn('year_number', function ($query, $keyword) {
                    $query->where('year_number', 'like', "%{$keyword}%")
                        ->orWhere('year', 'like', "%{$keyword}%")
                        ->orWhere('order_number', 'like', "%{$keyword}%");
                })
                ->addColumn('status_order', function ($row) {
                    // Define status order: 1=Finalizado, 2=Em Andamento, 3=Aguardando Início, 4=Atrasado
                    if ($row->completion_date) {
                        return 1;
                    } elseif ($row->deadline && $row->deadline < now()) {
                        return 4;
                    } elseif ($row->start_date) {
                        return 2;
                    } else {
                        return 3;
                    }
                })
                ->addColumn('status', function ($row) {
                    if ($row->completion_date) {
                        return '<span class="badge badge-success">Finalizado</span>';
                    } elseif ($row->deadline && $row->deadline < now()) {
                        return '<span class="badge badge-danger">Atrasado</span>';
                    } elseif ($row->start_date) {
                        return '<span class="badge badge-warning">Em Andamento</span>';
                    } else {
                        return '<span class="badge badge-secondary">Aguardando Início</span>';
                    }
                })
                ->orderColumn('status', function ($query, $order) {
                    // Ordena pelo status calculado
                    $query->orderByRaw("
                        CASE 
                            WHEN completion_date IS NOT NULL THEN 1
                            WHEN deadline IS NOT NULL AND deadline < NOW() THEN 4
                            WHEN start_date IS NOT NULL THEN 2
                            ELSE 3
                        END {$order}
                    ");
                })
                ->addColumn('priority_badge', function ($row) {
                    $badges = [
                        'urgent' => '<span class="badge badge-danger">Urgente</span>',
                        'high' => '<span class="badge badge-warning">Alta</span>',
                        'medium' => '<span class="badge badge-info">Média</span>',
                        'low' => '<span class="badge badge-secondary">Baixa</span>',
                    ];

                    return $badges[$row->priority] ?? '<span class="badge badge-secondary">-</span>';
                })
                ->editColumn('start_date', function ($row) {
                    return $row->start_date ? $row->start_date->format('d/m/Y') : '-';
                })
                ->editColumn('completion_date', function ($row) {
                    return $row->completion_date ? $row->completion_date->format('d/m/Y') : '-';
                })
                ->editColumn('deadline', function ($row) {
                    return $row->deadline ? $row->deadline->format('d/m/Y') : '-';
                })
                ->editColumn('request_date', function ($row) {
                    return $row->request_date ? $row->request_date->format('d/m/Y') : '-';
                })
                ->rawColumns(['action', 'status', 'priority_badge'])
                ->make(true);
        }

        return view('admin.pentests.index');
    }

    /**
     * Display the specified resource.
     */
    public function show(string $id): View|\Illuminate\Foundation\Application|Factory|Application
    {
        CheckPermission::checkAuth('Visualizar Pentests');

        $pentest = Pentest::find($id);
        if (! $pentest) {
            abort(403, 'Acesso não autorizado');
        }

        // Apply visibility filter based on user role
        $user = auth()->user();
        $vulnerabilitiesQuery = $pentest->vulnerabilities();

        $isPrivilegedUser = $user->hasAnyRole(['Programador', 'Administrador', 'Pentester']);
        if (! $isPrivilegedUser) {
            $vulnerabilitiesQuery->where('is_visible', true);
        }

        // Estatísticas gerais
        $totalVulnerabilities = (clone $vulnerabilitiesQuery)->count();
        $resolvedVulnerabilities = (clone $vulnerabilitiesQuery)->where('is_resolved', true)->count();
        $unresolvedVulnerabilities = $totalVulnerabilities - $resolvedVulnerabilities;
        $resolvedPercentage = $totalVulnerabilities > 0
            ? round(($resolvedVulnerabilities / $totalVulnerabilities) * 100, 1)
            : 0;

        // Contagem por criticidade (incluindo informativas)
        $criticalCount = (clone $vulnerabilitiesQuery)->where('criticality', 'critical')->count();
        $highCount = (clone $vulnerabilitiesQuery)->where('criticality', 'high')->count();
        $mediumCount = (clone $vulnerabilitiesQuery)->where('criticality', 'medium')->count();
        $lowCount = (clone $vulnerabilitiesQuery)->where('criticality', 'low')->count();
        $informativeCount = (clone $vulnerabilitiesQuery)->where('criticality', 'informative')->count();

        // Cálculo de dias restantes ou dias de atraso
        $deadlineInfo = null;
        if ($pentest->deadline && ! $pentest->completion_date) {
            $now = now();
            $deadline = $pentest->deadline;
            $diffInSeconds = $now->diffInSeconds($deadline, false);
            $isOverdue = $diffInSeconds < 0;

            $days = floor(abs($diffInSeconds) / 86400);
            $hours = floor((abs($diffInSeconds) % 86400) / 3600);

            $deadlineInfo = [
                'days' => $days,
                'hours' => $hours,
                'isOverdue' => $isOverdue,
            ];
        }

        // Vulnerabilidades agrupadas por criticidade para o gráfico
        $vulnerabilitiesByRisk = (clone $vulnerabilitiesQuery)
            ->selectRaw('criticality, COUNT(*) as total')
            ->groupBy('criticality')
            ->pluck('total', 'criticality')
            ->toArray();

        return view('admin.pentests.show', compact(
            'pentest',
            'vulnerabilitiesByRisk',
            'totalVulnerabilities',
            'resolvedVulnerabilities',
            'unresolvedVulnerabilities',
            'resolvedPercentage',
            'criticalCount',
            'highCount',
            'mediumCount',
            'lowCount',
            'informativeCount',
            'deadlineInfo'
        ));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create(): View|\Illuminate\Foundation\Application|Factory|Application
    {
        CheckPermission::checkAuth('Criar Pentests');

        return view('admin.pentests.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(PentestRequest $request): RedirectResponse
    {
        CheckPermission::checkAuth('Criar Pentests');

        $data = $request->all();

        // Gerar número sequencial por ano
        $year = $request->start_date ? date('Y', strtotime($request->start_date)) : date('Y');
        $lastPentest = Pentest::where('year', $year)
            ->orderBy('order_number', 'desc')
            ->first();

        $orderNumber = $lastPentest ? $lastPentest->order_number + 1 : 1;

        $data['year'] = $year;
        $data['order_number'] = $orderNumber;
        $data['year_number'] = sprintf('%02d/%s', $orderNumber, $year);

        if ($request->hasFile('report_file') && $request->file('report_file')->isValid()) {
            $fileName = 'pentest_'.Str::slug($data['version']).'_'.time().'.'.$request->file('report_file')->getClientOriginalExtension();
            $request->file('report_file')->storeAs('pentests', $fileName, 'public');
            $data['report_file'] = $fileName;
        }

        // Process rich text fields with images
        if ($request->risk_assessment) {
            $data['risk_assessment'] = TextProcessor::store($request->application_name, 'pentests', $request->risk_assessment);
        }
        if ($request->conclusion) {
            $data['conclusion'] = TextProcessor::store($request->application_name, 'pentests', $request->conclusion);
        }

        $pentest = Pentest::create($data);

        if ($pentest->save()) {
            return redirect()
                ->route('admin.pentests.index')
                ->with('success', 'Cadastro realizado!');
        } else {
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Erro ao cadastrar!');
        }
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(string $id): View|\Illuminate\Foundation\Application|Factory|Application
    {
        CheckPermission::checkAuth('Editar Pentests');

        $pentest = Pentest::find($id);
        if (! $pentest) {
            abort(403, 'Acesso não autorizado');
        }

        return view('admin.pentests.edit', compact('pentest'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(PentestRequest $request, string $id): RedirectResponse
    {
        CheckPermission::checkAuth('Editar Pentests');

        $pentest = Pentest::find($id);
        if (! $pentest) {
            abort(403, 'Acesso não autorizado');
        }

        $data = $request->all();

        // Check if user wants to remove the report file
        if ($request->has('remove_report_file') && $request->remove_report_file == '1') {
            if ($pentest->report_file && File::exists(storage_path('app/public/pentests/'.$pentest->report_file))) {
                File::delete(storage_path('app/public/pentests/'.$pentest->report_file));
            }
            $data['report_file'] = null;
        }

        if ($request->hasFile('report_file') && $request->file('report_file')->isValid()) {
            // Remove arquivo antigo se existir
            if ($pentest->report_file && File::exists(storage_path('app/public/pentests/'.$pentest->report_file))) {
                File::delete(storage_path('app/public/pentests/'.$pentest->report_file));
            }

            $fileName = 'pentest_'.Str::slug($data['version']).'_'.time().'.'.$request->file('report_file')->getClientOriginalExtension();
            $request->file('report_file')->storeAs('pentests', $fileName, 'public');
            $data['report_file'] = $fileName;
        }

        // Process rich text fields with images
        if ($request->risk_assessment) {
            $data['risk_assessment'] = TextProcessor::store($request->application_name, 'pentests', $request->risk_assessment);
        }
        if ($request->conclusion) {
            $data['conclusion'] = TextProcessor::store($request->application_name, 'pentests', $request->conclusion);
        }

        if ($pentest->update($data)) {
            return redirect()
                ->route('admin.pentests.index')
                ->with('success', 'Atualização realizada!');
        } else {
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Erro ao atualizar!');
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(string $id): RedirectResponse
    {
        CheckPermission::checkAuth('Excluir Pentests');

        $pentest = Pentest::find($id);
        if (! $pentest) {
            abort(403, 'Acesso não autorizado');
        }

        $year = $pentest->year;
        $deletedOrderNumber = $pentest->order_number;

        // Não remove o arquivo fisicamente para manter histórico
        if ($pentest->delete()) {
            // Reordenar pentests do mesmo ano que têm order_number maior que o deletado
            $pentestsToReorder = Pentest::where('year', $year)
                ->where('order_number', '>', $deletedOrderNumber)
                ->orderBy('order_number')
                ->get();

            foreach ($pentestsToReorder as $p) {
                $newOrderNumber = $p->order_number - 1;
                $p->update([
                    'order_number' => $newOrderNumber,
                    'year_number' => sprintf('%02d/%s', $newOrderNumber, $year),
                ]);
            }

            return redirect()
                ->route('admin.pentests.index')
                ->with('success', 'Exclusão realizada!');
        } else {
            return redirect()
                ->back()
                ->with('error', 'Erro ao excluir!');
        }
    }
}
