<?php

namespace App\Http\Controllers\Admin;

use App\Helpers\CheckPermission;
use App\Helpers\TextProcessor;
use App\Http\Controllers\Controller;
use App\Http\Requests\Admin\VulnerabilityRequest;
use App\Models\Pentest;
use App\Models\Vulnerability;
use Illuminate\Contracts\Foundation\Application;
use Illuminate\Contracts\View\Factory;
use Illuminate\Contracts\View\View;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Str;
use Yajra\DataTables\Facades\DataTables;

class VulnerabilityController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index(Request $request): View|Factory|Application|JsonResponse
    {
        CheckPermission::checkAuth('Listar Vulnerabilidades');

        if ($request->ajax()) {
            $query = Vulnerability::with('pentest:id,application_name')
                ->select([
                    'id',
                    'pentest_id',
                    'display_order',
                    'is_visible',
                    'description',
                    'criticality',
                    'is_resolved',
                    'resolved_at',
                ]);

            // Filter by pentest if provided
            if ($request->has('pentest_id') && $request->pentest_id) {
                $query->where('pentest_id', $request->pentest_id);
            }

            // Apply visibility filter based on user role
            $user = auth()->user();
            $isPrivilegedUser = $user->hasAnyRole(['Programador', 'Administrador', 'Pentester']);

            if (! $isPrivilegedUser) {
                // Gestor, Coordenador, Desenvolvedor só veem vulnerabilidades visíveis
                $query->where('is_visible', true);
            }

            $vulnerabilities = $query->orderBy('display_order', 'asc')->get();
            $token = csrf_token();

            return DataTables::of($vulnerabilities)
                ->addIndexColumn()
                ->addColumn('action', function ($row) use ($token) {
                    return '<a class="btn btn-xs btn-info mx-1 shadow" title="Visualizar" href="vulnerabilities/'.$row->id.'"><i class="fa fa-lg fa-fw fa-eye"></i></a>'.
                        '<a class="btn btn-xs btn-primary mx-1 shadow" title="Editar" href="vulnerabilities/'.$row->id.'/edit"><i class="fa fa-lg fa-fw fa-pen"></i></a>'.
                        '<form method="POST" action="vulnerabilities/'.$row->id.'" class="btn btn-xs px-0"><input type="hidden" name="_method" value="DELETE"><input type="hidden" name="_token" value="'.$token.'"><button class="btn btn-xs btn-danger mx-1 shadow" title="Excluir" onclick="return confirm(\'Confirma a exclusão desta vulnerabilidade?\')"><i class="fa fa-lg fa-fw fa-trash"></i></button></form>';
                })
                ->addColumn('pentest', function ($row) {
                    return $row->pentest ? $row->pentest->application_name : '-';
                })
                ->addColumn('criticality_badge', function ($row) {
                    $badges = [
                        'critical' => '<span class="badge" style="background-color: #000000; color: #ffffff;">CRÍTICA</span>',
                        'high' => '<span class="badge" style="background-color: #dc3545; color: #ffffff;">ALTA</span>',
                        'medium' => '<span class="badge" style="background-color: #fd7e14; color: #ffffff;">MÉDIA</span>',
                        'low' => '<span class="badge" style="background-color: #17a2b8; color: #ffffff;">BAIXA</span>',
                        'informative' => '<span class="badge" style="background-color: #28a745; color: #ffffff;">INFORMATIVA</span>',
                    ];

                    // Define criticality order: 1=Critical, 2=High, 3=Medium, 4=Low, 5=Informative
                    $criticalityOrder = [
                        'critical' => 1,
                        'high' => 2,
                        'medium' => 3,
                        'low' => 4,
                        'informative' => 5,
                    ];

                    $badge = $badges[$row->criticality] ?? '-';
                    $order = $criticalityOrder[$row->criticality] ?? 999;

                    return '<span data-order="'.$order.'">'.$badge.'</span>';
                })
                ->addColumn('status_badge', function ($row) {
                    // Define status order: 1=Mitigada, 2=Não Mitigada
                    $statusOrder = $row->is_resolved ? 1 : 2;
                    $badge = $row->is_resolved
                        ? '<span class="badge badge-success">Mitigada</span>'
                        : '<span class="badge badge-danger">Não Mitigada</span>';

                    return '<span data-order="'.$statusOrder.'">'.$badge.'</span>';
                })
                ->editColumn('resolved_at', function ($row) {
                    $formatted = $row->resolved_at ? $row->resolved_at->format('d/m/Y') : '-';
                    $sortValue = $row->resolved_at ? $row->resolved_at->format('Y-m-d') : '9999-12-31';

                    return '<span data-order="'.$sortValue.'">'.$formatted.'</span>';
                })
                ->editColumn('description', function ($row) {
                    return Str::limit(strip_tags($row->description), 80);
                })
                ->rawColumns(['action', 'criticality_badge', 'status_badge', 'resolved_at'])
                ->make(true);
        }

        return view('admin.vulnerabilities.index');
    }

    /**
     * Display the specified resource.
     */
    public function show(string $id): View|\Illuminate\Foundation\Application|Factory|Application
    {
        CheckPermission::checkAuth('Visualizar Vulnerabilidades');

        $vulnerability = Vulnerability::with('pentest')->find($id);
        if (! $vulnerability) {
            abort(403, 'Acesso não autorizado');
        }

        // Check visibility based on user role
        $user = auth()->user();
        $isPrivilegedUser = $user->hasAnyRole(['Programador', 'Administrador', 'Pentester']);

        if (! $isPrivilegedUser && ! $vulnerability->is_visible) {
            abort(403, 'Acesso não autorizado');
        }

        return view('admin.vulnerabilities.show', compact('vulnerability'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create(Request $request): View|\Illuminate\Foundation\Application|Factory|Application
    {
        CheckPermission::checkAuth('Criar Vulnerabilidades');

        // Validate pentest_id from POST request
        $pentestId = $request->input('pentest_id');
        if (! $pentestId) {
            abort(400, 'ID do pentest é obrigatório');
        }

        $pentest = Pentest::find($pentestId);
        if (! $pentest) {
            abort(404, 'Pentest não encontrado');
        }

        return view('admin.vulnerabilities.create', compact('pentest'));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(VulnerabilityRequest $request): RedirectResponse
    {
        CheckPermission::checkAuth('Criar Vulnerabilidades');

        $data = $request->all();

        // Handle display_order
        if ($request->filled('display_order')) {
            $desiredOrder = (int) $request->display_order;

            // Shift all vulnerabilities with display_order >= desired order
            Vulnerability::where('pentest_id', $request->pentest_id)
                ->where('display_order', '>=', $desiredOrder)
                ->increment('display_order');

            $data['display_order'] = $desiredOrder;
        } else {
            // Get the next display_order for this pentest
            $maxOrder = Vulnerability::where('pentest_id', $request->pentest_id)->max('display_order') ?? 0;
            $data['display_order'] = $maxOrder + 1;
        }

        // Process mitigation_action with TextProcessor if present
        if ($request->mitigation_action) {
            $data['mitigation_action'] = TextProcessor::store($request->pentest_id, 'pentests/vulnerabilities', $request->mitigation_action);
        }

        // Process recommendations with TextProcessor if present
        if ($request->recommendations) {
            $data['recommendations'] = TextProcessor::store($request->pentest_id, 'pentests/vulnerabilities', $request->recommendations);
        }

        $vulnerability = Vulnerability::create($data);

        return redirect()
            ->route('admin.pentests.show', $vulnerability->pentest)
            ->with('success', 'Vulnerabilidade cadastrada!');
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(string $id): View|\Illuminate\Foundation\Application|Factory|Application
    {
        CheckPermission::checkAuth('Editar Vulnerabilidades');

        $vulnerability = Vulnerability::with('pentest')->find($id);
        if (! $vulnerability) {
            abort(403, 'Acesso não autorizado');
        }

        // Check visibility based on user role
        $user = auth()->user();
        $isPrivilegedUser = $user->hasAnyRole(['Programador', 'Administrador', 'Pentester']);

        if (! $isPrivilegedUser && ! $vulnerability->is_visible) {
            abort(403, 'Acesso não autorizado');
        }

        return view('admin.vulnerabilities.edit', compact('vulnerability'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(VulnerabilityRequest $request, string $id): RedirectResponse
    {
        CheckPermission::checkAuth('Editar Vulnerabilidades');

        $vulnerability = Vulnerability::find($id);
        if (! $vulnerability) {
            abort(403, 'Acesso não autorizado');
        }

        // Check visibility based on user role
        $user = auth()->user();
        $isPrivilegedUser = $user->hasAnyRole(['Programador', 'Administrador', 'Pentester']);

        if (! $isPrivilegedUser && ! $vulnerability->is_visible) {
            abort(403, 'Acesso não autorizado');
        }

        $data = $request->all();

        // Handle display_order changes
        if ($request->filled('display_order')) {
            $newOrder = (int) $request->display_order;
            $oldOrder = $vulnerability->display_order;

            if ($newOrder !== $oldOrder) {
                $pentestId = $vulnerability->pentest_id;

                if ($newOrder > $oldOrder) {
                    // Moving down: decrement items between old and new position
                    Vulnerability::where('pentest_id', $pentestId)
                        ->where('id', '!=', $id)
                        ->where('display_order', '>', $oldOrder)
                        ->where('display_order', '<=', $newOrder)
                        ->decrement('display_order');
                } else {
                    // Moving up: increment items between new and old position
                    Vulnerability::where('pentest_id', $pentestId)
                        ->where('id', '!=', $id)
                        ->where('display_order', '>=', $newOrder)
                        ->where('display_order', '<', $oldOrder)
                        ->increment('display_order');
                }

                $data['display_order'] = $newOrder;
            }
        }

        // Process mitigation_action with TextProcessor if present
        if ($request->mitigation_action) {
            $data['mitigation_action'] = TextProcessor::store($request->pentest_id, 'pentests/vulnerabilities', $request->mitigation_action);
        }

        // Process recommendations with TextProcessor if present
        if ($request->recommendations) {
            $data['recommendations'] = TextProcessor::store($request->pentest_id, 'pentests/vulnerabilities', $request->recommendations);
        }

        if ($vulnerability->update($data)) {
            return redirect()
                ->route('admin.pentests.show', $vulnerability->pentest)
                ->with('success', 'Vulnerabilidade atualizada!');
        } else {
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Erro ao atualizar!');
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(string $id): RedirectResponse
    {
        CheckPermission::checkAuth('Excluir Vulnerabilidades');

        $vulnerability = Vulnerability::find($id);
        if (! $vulnerability) {
            abort(403, 'Acesso não autorizado');
        }

        // Check visibility based on user role
        $user = auth()->user();
        $isPrivilegedUser = $user->hasAnyRole(['Programador', 'Administrador', 'Pentester']);

        if (! $isPrivilegedUser && ! $vulnerability->is_visible) {
            abort(403, 'Acesso não autorizado');
        }

        $pentestId = $vulnerability->pentest_id;
        $deletedOrder = $vulnerability->display_order;

        if ($vulnerability->delete()) {
            // Reorder remaining vulnerabilities for this pentest
            Vulnerability::where('pentest_id', $pentestId)
                ->where('display_order', '>', $deletedOrder)
                ->decrement('display_order');

            return redirect()
                ->route('admin.pentests.show', $pentestId)
                ->with('success', 'Vulnerabilidade excluída!');
        } else {
            return redirect()
                ->back()
                ->with('error', 'Erro ao excluir!');
        }
    }

    /**
     * DataTable for pentest vulnerabilities.
     */
    public function datatable(Request $request, string $pentestId): JsonResponse
    {
        CheckPermission::checkAuth('Visualizar Pentests');

        $query = Vulnerability::where('pentest_id', $pentestId)
            ->select([
                'id',
                'display_order',
                'description',
                'criticality',
                'is_resolved',
                'resolved_at',
            ]);

        // Apply visibility filter based on user role
        $user = auth()->user();
        $isPrivilegedUser = $user->hasAnyRole(['Programador', 'Administrador', 'Pentester']);

        if (! $isPrivilegedUser) {
            $query->where('is_visible', true);
        }

        $vulnerabilities = $query->orderBy('display_order', 'asc')->get();

        $token = csrf_token();

        return DataTables::of($vulnerabilities)
            ->addIndexColumn()
            ->addColumn('action', function ($row) use ($token) {
                return '<a class="btn btn-xs btn-info mx-1 shadow" title="Visualizar" href="'.route('admin.vulnerabilities.show', $row->id).'"><i class="fa fa-lg fa-fw fa-eye"></i></a>'.
                    '<a class="btn btn-xs btn-primary mx-1 shadow" title="Editar" href="'.route('admin.vulnerabilities.edit', $row->id).'"><i class="fa fa-lg fa-fw fa-pen"></i></a>'.
                    '<form method="POST" action="'.route('admin.vulnerabilities.destroy', $row->id).'" class="btn btn-xs px-0"><input type="hidden" name="_method" value="DELETE"><input type="hidden" name="_token" value="'.$token.'"><button class="btn btn-xs btn-danger mx-1 shadow" title="Excluir" onclick="return confirm(\'Confirma a exclusão desta vulnerabilidade?\');"><i class="fa fa-lg fa-fw fa-trash"></i></button></form>';
            })
            ->addColumn('criticality_badge', function ($row) {
                $badges = [
                    'critical' => '<span class="badge" style="background-color: #000000; color: #ffffff;">CRÍTICA</span>',
                    'high' => '<span class="badge" style="background-color: #dc3545; color: #ffffff;">ALTA</span>',
                    'medium' => '<span class="badge" style="background-color: #fd7e14; color: #ffffff;">MÉDIA</span>',
                    'low' => '<span class="badge" style="background-color: #17a2b8; color: #ffffff;">BAIXA</span>',
                    'informative' => '<span class="badge" style="background-color: #28a745; color: #ffffff;">INFORMATIVA</span>',
                ];

                return $badges[$row->criticality] ?? '-';
            })
            ->addColumn('status_badge', function ($row) {
                return $row->is_resolved
                    ? '<span class="badge badge-success">Mitigada</span>'
                    : '<span class="badge badge-danger">Não Mitigada</span>';
            })
            ->editColumn('resolved_at', function ($row) {
                $formatted = $row->resolved_at ? $row->resolved_at->format('d/m/Y') : '-';
                $sortValue = $row->resolved_at ? $row->resolved_at->format('Y-m-d') : '9999-12-31';

                return '<span data-order="'.$sortValue.'">'.$formatted.'</span>';
            })
            ->editColumn('description', function ($row) {
                return Str::limit(strip_tags($row->description), 100);
            })
            ->rawColumns(['action', 'criticality_badge', 'status_badge', 'resolved_at'])
            ->make(true);
    }
}
