<?php

use App\Models\Pentest;
use App\Models\Vulnerability;
use Carbon\Carbon;

// Dados para geração aleatória
$applications = [
    'Portal Corporativo', 'Sistema ERP', 'API REST', 'Mobile App',
    'E-commerce', 'CRM', 'Sistema Financeiro', 'Portal Cliente',
    'Intranet', 'Sistema RH', 'Dashboard Analytics', 'Plataforma Digital',
    'Sistema Logística', 'Portal Fornecedores', 'App Mobile Banking',
];

$responsibles = ['João Silva', 'Maria Santos', 'Carlos Oliveira', 'Ana Costa', 'Pedro Almeida'];
$applicants = ['Equipe Segurança', 'DevSecOps Team', 'Security Team', 'Infra Security', 'AppSec Team'];
$priorities = ['low', 'medium', 'high', 'urgent'];
$criticalities = ['informative', 'low', 'medium', 'high', 'critical'];

$vulnerabilityDescriptions = [
    'SQL Injection na busca de usuários',
    'Cross-Site Scripting (XSS) no formulário de comentários',
    'Exposição de informações sensíveis no log',
    'Autenticação fraca com senhas padrão',
    'CSRF na funcionalidade de transferência',
    'Falta de validação de entrada em upload de arquivos',
    'Sessão não expira após logout',
    'Credenciais hardcoded no código-fonte',
    'Falta de rate limiting na API',
    'Cabeçalhos de segurança ausentes',
    'Configuração inadequada de CORS',
    'Uso de bibliotecas desatualizadas',
    'Falta de criptografia em dados sensíveis',
    'Path Traversal em download de arquivos',
    'Injection em comando do sistema operacional',
    'Deserialização insegura',
    'Exposição de endpoints administrativos',
    'Broken Access Control',
    'Security Misconfiguration',
    'Sensitive Data Exposure',
];

$notes = [
    'Teste realizado conforme escopo aprovado.',
    'Identificadas vulnerabilidades críticas que necessitam atenção imediata.',
    'Sistema apresenta boas práticas de segurança em geral.',
    'Recomendada revisão completa da arquitetura de autenticação.',
    'Necessário atualizar dependências vulneráveis.',
    null,
];

echo "Iniciando criação de 50 pentests...\n\n";

for ($i = 1; $i <= 50; $i++) {
    // Define ano distribuído entre 2024, 2025 e 2026
    $rand = rand(1, 10);
    if ($rand <= 2) {
        $year = 2024;
    } elseif ($rand <= 5) {
        $year = 2025;
    } else {
        $year = 2026;
    }

    // Busca o maior order_number do ano
    $maxOrder = Pentest::where('year', $year)->max('order_number') ?? 0;
    $orderNumber = $maxOrder + 1;
    $yearNumber = str_pad($orderNumber, 2, '0', STR_PAD_LEFT).'/'.$year;

    // Define datas base
    $startDate = null;
    $completionDate = null;
    $deliveryDate = null;
    $deadline = null;

    // 70% tem data de início
    if (rand(1, 10) > 3) {
        $startDate = Carbon::create($year, rand(1, 12), rand(1, 28));

        // 60% dos que iniciaram têm prazo
        if (rand(1, 10) > 4) {
            $deadline = (clone $startDate)->addDays(rand(15, 90));
        }

        // 50% dos que iniciaram foram finalizados
        if (rand(1, 10) > 5) {
            $completionDate = (clone $startDate)->addDays(rand(10, 80));

            // 80% dos finalizados têm data de entrega
            if (rand(1, 10) > 2) {
                $deliveryDate = (clone $completionDate)->addDays(rand(1, 10));
            }
        }
    }

    $pentest = Pentest::create([
        'application_name' => $applications[array_rand($applications)].' v'.rand(1, 5).'.'.rand(0, 9),
        'year' => $year,
        'order_number' => $orderNumber,
        'year_number' => $yearNumber,
        'version' => rand(1, 5).'.'.rand(0, 9).'.'.rand(0, 20),
        'responsible' => $responsibles[array_rand($responsibles)],
        'priority' => $priorities[array_rand($priorities)],
        'start_date' => $startDate,
        'completion_date' => $completionDate,
        'delivery_date' => $deliveryDate,
        'deadline' => $deadline,
        'applicant' => $applicants[array_rand($applicants)],
        'notes' => $notes[array_rand($notes)],
        'risk_assessment' => rand(1, 10) > 3 ? '<p>Análise de risco realizada. '.(rand(1, 10) > 5 ? 'Riscos elevados identificados.' : 'Riscos moderados a baixos.').'</p>' : null,
        'conclusion' => rand(1, 10) > 3 ? '<p>Durante a execução dos testes de segurança, foram identificadas diversas vulnerabilidades que impactam diretamente a segurança da aplicação. A análise técnica revelou falhas críticas que podem comprometer a confidencialidade, integridade e disponibilidade dos dados.</p><p>As vulnerabilidades encontradas incluem problemas relacionados a falhas de autenticação e autorização, exposição de informações sensíveis, validação inadequada de entrada de dados, e configurações inseguras de servidor. Essas falhas podem ser exploradas por atacantes mal-intencionados para obter acesso não autorizado ao sistema.</p><p>Recomenda-se que a equipe de desenvolvimento priorize a correção das vulnerabilidades críticas e altas imediatamente, seguindo as orientações detalhadas fornecidas no relatório. As vulnerabilidades médias e baixas devem ser tratadas em um segundo momento, mas não devem ser negligenciadas.</p><p>É importante estabelecer um programa contínuo de segurança da informação que inclua revisões periódicas de código, testes de penetração regulares, treinamento de desenvolvedores em práticas seguras de programação e implementação de um processo de gestão de vulnerabilidades.</p><p>A aplicação de patches de segurança, atualização de bibliotecas e frameworks para versões mais recentes, implementação de controles de segurança em camadas e monitoramento contínuo são medidas essenciais para manter o nível adequado de segurança.</p><p>Conclui-se que o sistema necessita de atenção imediata nas áreas identificadas e que o comprometimento da equipe técnica é fundamental para garantir a segurança dos dados e a continuidade dos negócios da organização.</p>' : null,
    ]);

    // Criar vulnerabilidades (entre 0 e 15)
    $numVulnerabilities = rand(0, 15);

    for ($j = 0; $j < $numVulnerabilities; $j++) {
        $criticality = $criticalities[array_rand($criticalities)];
        $isResolved = rand(1, 10) > 4; // 60% mitigadas
        $resolvedAt = null;

        if ($isResolved && $completionDate) {
            $resolvedAt = (clone $startDate)->addDays(rand(5, 70));
        } elseif ($isResolved && $startDate) {
            $resolvedAt = (clone $startDate)->addDays(rand(5, 30));
        }

        Vulnerability::create([
            'pentest_id' => $pentest->id,
            'description' => $vulnerabilityDescriptions[array_rand($vulnerabilityDescriptions)],
            'criticality' => $criticality,
            'is_resolved' => $isResolved,
            'resolved_at' => $resolvedAt,
            'recommendations' => rand(1, 10) > 5 ? '<p>Para mitigar esta vulnerabilidade, é fundamental implementar uma abordagem em múltiplas camadas que inclua validação rigorosa de entrada de dados, sanitização adequada de saídas e implementação de controles de segurança apropriados.</p><p>Recomenda-se a utilização de frameworks e bibliotecas atualizadas que ofereçam proteções nativas contra este tipo de vulnerabilidade. É essencial aplicar o princípio do menor privilégio em todos os níveis da aplicação e implementar controles de acesso baseados em funções.</p><p>A equipe de desenvolvimento deve realizar uma revisão completa do código-fonte para identificar outras instâncias similares desta vulnerabilidade. Utilize ferramentas de análise estática de código (SAST) e análise dinâmica (DAST) para automatizar a detecção de falhas de segurança.</p><p>Implemente testes de segurança automatizados no pipeline de CI/CD para prevenir a introdução de novas vulnerabilidades. Estabeleça políticas de codificação segura e realize treinamentos regulares com a equipe técnica sobre as melhores práticas de desenvolvimento seguro.</p><p>Configure adequadamente os cabeçalhos de segurança HTTP, implemente Content Security Policy (CSP), ative proteções contra CSRF e garanta que todas as comunicações utilizem TLS 1.2 ou superior. Mantenha um inventário atualizado de todas as dependências e monitore continuamente por vulnerabilidades conhecidas.</p><p>Por fim, estabeleça um processo de resposta a incidentes e mantenha logs detalhados de todas as atividades críticas do sistema para facilitar investigações futuras e melhorar continuamente a postura de segurança da aplicação.</p>' : null,
        ]);
    }

    echo "Pentest $i criado: {$yearNumber} - {$pentest->application_name} ({$numVulnerabilities} vulnerabilidades)\n";
}

echo "\n✅ Concluído! 50 pentests criados com sucesso!\n";
