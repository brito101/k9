<?php

use App\Models\Pentest;
use App\Models\Vulnerability;
use Carbon\Carbon;

// Dados para geração aleatória
$applications = [
    'Portal Corporativo', 'Sistema ERP', 'API REST', 'Mobile App',
    'E-commerce', 'CRM', 'Sistema Financeiro', 'Portal Cliente',
    'Intranet', 'Sistema RH', 'Dashboard Analytics', 'Plataforma Digital',
    'Sistema Logística', 'Portal Fornecedores', 'App Mobile Banking',
];

$authors = ['João Silva', 'Maria Santos', 'Carlos Oliveira', 'Ana Costa', 'Pedro Almeida'];
$responsibles = ['Equipe Segurança', 'DevSecOps Team', 'Security Team', 'Infra Security', 'AppSec Team'];
$priorities = ['low', 'medium', 'high', 'urgent'];
$criticalities = ['informative', 'low', 'medium', 'high', 'critical'];

$vulnerabilityDescriptions = [
    'SQL Injection na busca de usuários',
    'Cross-Site Scripting (XSS) no formulário de comentários',
    'Exposição de informações sensíveis no log',
    'Autenticação fraca com senhas padrão',
    'CSRF na funcionalidade de transferência',
    'Falta de validação de entrada em upload de arquivos',
    'Sessão não expira após logout',
    'Credenciais hardcoded no código-fonte',
    'Falta de rate limiting na API',
    'Cabeçalhos de segurança ausentes',
    'Configuração inadequada de CORS',
    'Uso de bibliotecas desatualizadas',
    'Falta de criptografia em dados sensíveis',
    'Path Traversal em download de arquivos',
    'Injection em comando do sistema operacional',
    'Deserialização insegura',
    'Exposição de endpoints administrativos',
    'Broken Access Control',
    'Security Misconfiguration',
    'Sensitive Data Exposure',
];

$notes = [
    'Teste realizado conforme escopo aprovado.',
    'Identificadas vulnerabilidades críticas que necessitam atenção imediata.',
    'Sistema apresenta boas práticas de segurança em geral.',
    'Recomendada revisão completa da arquitetura de autenticação.',
    'Necessário atualizar dependências vulneráveis.',
    null,
];

echo "Iniciando criação de 50 pentests...\n\n";

for ($i = 1; $i <= 50; $i++) {
    // Define ano distribuído entre 2024, 2025 e 2026
    $rand = rand(1, 10);
    if ($rand <= 2) {
        $year = 2024;
    } elseif ($rand <= 5) {
        $year = 2025;
    } else {
        $year = 2026;
    }

    // Busca o maior order_number do ano
    $maxOrder = Pentest::where('year', $year)->max('order_number') ?? 0;
    $orderNumber = $maxOrder + 1;
    $yearNumber = str_pad($orderNumber, 2, '0', STR_PAD_LEFT).'/'.$year;

    // Define datas base
    $startDate = null;
    $completionDate = null;
    $deliveryDate = null;
    $deadline = null;

    // 70% tem data de início
    if (rand(1, 10) > 3) {
        $startDate = Carbon::create($year, rand(1, 12), rand(1, 28));

        // 60% dos que iniciaram têm prazo
        if (rand(1, 10) > 4) {
            $deadline = (clone $startDate)->addDays(rand(15, 90));
        }

        // 50% dos que iniciaram foram finalizados
        if (rand(1, 10) > 5) {
            $completionDate = (clone $startDate)->addDays(rand(10, 80));

            // 80% dos finalizados têm data de entrega
            if (rand(1, 10) > 2) {
                $deliveryDate = (clone $completionDate)->addDays(rand(1, 10));
            }
        }
    }

    $pentest = Pentest::create([
        'application_name' => $applications[array_rand($applications)].' v'.rand(1, 5).'.'.rand(0, 9),
        'year' => $year,
        'order_number' => $orderNumber,
        'year_number' => $yearNumber,
        'version' => rand(1, 5).'.'.rand(0, 9).'.'.rand(0, 20),
        'author' => $authors[array_rand($authors)],
        'priority' => $priorities[array_rand($priorities)],
        'start_date' => $startDate,
        'completion_date' => $completionDate,
        'delivery_date' => $deliveryDate,
        'deadline' => $deadline,
        'responsible' => $responsibles[array_rand($responsibles)],
        'notes' => $notes[array_rand($notes)],
        'risk_assessment' => rand(1, 10) > 3 ? '<p>Análise de risco realizada. '.(rand(1, 10) > 5 ? 'Riscos elevados identificados.' : 'Riscos moderados a baixos.').'</p>' : null,
        'conclusion' => rand(1, 10) > 3 ? '<p>Conclusão: '.(rand(1, 10) > 5 ? 'Sistema necessita melhorias urgentes de segurança.' : 'Sistema apresenta nível aceitável de segurança.').'</p>' : null,
    ]);

    // Criar vulnerabilidades (entre 0 e 15)
    $numVulnerabilities = rand(0, 15);

    for ($j = 0; $j < $numVulnerabilities; $j++) {
        $criticality = $criticalities[array_rand($criticalities)];
        $isResolved = rand(1, 10) > 4; // 60% sanadas
        $resolvedAt = null;

        if ($isResolved && $completionDate) {
            $resolvedAt = (clone $startDate)->addDays(rand(5, 70));
        } elseif ($isResolved && $startDate) {
            $resolvedAt = (clone $startDate)->addDays(rand(5, 30));
        }

        Vulnerability::create([
            'pentest_id' => $pentest->id,
            'description' => $vulnerabilityDescriptions[array_rand($vulnerabilityDescriptions)],
            'criticality' => $criticality,
            'is_resolved' => $isResolved,
            'resolved_at' => $resolvedAt,
            'observations' => rand(1, 10) > 5 ? 'Observação: '.($isResolved ? 'Vulnerabilidade corrigida conforme recomendação.' : 'Aguardando correção da equipe de desenvolvimento.') : null,
        ]);
    }

    echo "Pentest $i criado: {$yearNumber} - {$pentest->application_name} ({$numVulnerabilities} vulnerabilidades)\n";
}

echo "\n✅ Concluído! 50 pentests criados com sucesso!\n";
